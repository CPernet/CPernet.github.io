<html xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--
This HTML is auto-generated from an M-file.
To make changes, update the M-file and republish this document.
      -->
      <title>Cyril Pernet GLM </title>
      <meta name="description" content="Doing ANOVAs using the GLM">
      <meta name="keywords" content="Cyril Pernet GLM ANOVA">

      <meta name="generator" content="MATLAB 7.2">
      <meta name="date" content="2008-03-16">
      <meta name="m-file" content="cp_glm3"><style>

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows.  On Gecko-based browsers, the shrink-to-fit doesn't work. */ 
p,h1,h2,div.content div {
  /* for MATLAB's browser */
  width: 600px;
  /* for Mozilla, but the "width" tag overrides it anyway */
  max-width: 600px;
  /* for IE */
  width:expression(document.body.clientWidth > 620 ? "600px": "auto" );
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head>
   <body>
      <div class="content">
         <h2>Contents</h2>
         <div>
            <ul>
               <li><a href="../cp_stats.html">Home</a></li>
               <li><a href="#2">One way ANOVA</a></li>
               <li><a href="#3">Two way ANOVA</a></li>
               <li><a href="#4">Repeated measures ANOVA</a></li>
               <li><a href="#6">Embeded ANOVA design (1 factor independant, 1 factor repeated)</a></li>
               <li><a href="cp_glm4.html">GLM4</a></li>
            </ul>
        </div><pre class="codeinput"><span class="comment">% In this last page I review the different ANOVA</span>
<span class="comment">% models and how to implement them in matlab using</span>
<span class="comment">% the glm</span>
</pre><h2>One way ANOVA<a name="2"></a></h2><pre class="codeinput"><span class="comment">%----------------------------------%</span>
<span class="comment">%  SS total = SS intra + SS inter  %</span>
<span class="comment">%----------------------------------%</span>
<span class="comment">% this repeat what was explained in glm2</span>


<span class="comment">% --------------------------------------------------</span>
<span class="comment">%                           gp 1   gp2   gp3   gp4</span>
<span class="comment">% --------------------------------------------------</span>
<span class="comment">% observation 1               8     5     3     6</span>
<span class="comment">% observation 2               9     7     4     4</span>
<span class="comment">% observation 3               7     3     1     9</span>
<span class="comment">% --------------------------------------------------</span>

clear

<span class="comment">%data</span>
y = [8 9 7 5 7 3 3 4 1 6 4 9]';

<span class="comment">% design matrix</span>
n = 3;
X = [ones(1,n) zeros(1,2*n) (ones(1,n)*-1); <span class="keyword">...</span>
       zeros(1,n) ones(1,n) zeros(1,n) (ones(1,n)*-1); <span class="keyword">...</span>
       zeros(1,2*n) ones(1,n) (ones(1,n)*-1)]';

<span class="comment">% solve</span>
[betas, error, stats] = glmfit(X,y,<span class="string">'normal'</span>);
yhat                  = glmval(betas, X, <span class="string">'identity'</span>);
ss_total              = norm(y - mean(y)).^2;
ss_effect             = norm(yhat - mean(yhat)).^2;
Rsquare               = ss_effect/ss_total; <span class="comment">% adjustment of the all model</span>
F                     = (Rsquare *(length(y)-rank(X)-1))/((1- Rsquare)*rank(X));
pval                  = 1 - fcdf(F, rank(X), (length(y)-rank(X)-1));

<span class="comment">% figures</span>
figure
subplot(1,2,1); imagesc(X); colormap(<span class="string">'gray'</span>);
title(<span class="string">'One way ANOVA 4 gps'</span>)
subplot(1,2,2);
plot(y); hold <span class="string">on</span>; plot(yhat,<span class="string">'r'</span>); axis <span class="string">tight</span>
mytitle = sprintf(<span class="string">'R square = %g'</span>, Rsquare);
title({<span class="string">'model and data'</span>;[mytitle]})
figure;
subplot(1,2,1);
boxplot([8 9 7 ;5 7 3 ;3 4 1 ;6 4 9]');
mytitle = sprintf(<span class="string">'F(%g,%g)=%g, p=%g'</span>,(length(y)-rank(X)-1), rank(X), F, pval);
title([mytitle])
subplot(1,2,2); normplot(y-yhat);
</pre><img vspace="5" hspace="5" src="cp_glm3_01.png"> <img vspace="5" hspace="5" src="cp_glm3_02.png"> <h2>Two way ANOVA<a name="3"></a></h2><pre class="codeinput"><span class="comment">%---------------------------------------------------------------------%</span>
<span class="comment">%  SS total = SS factor 1 + SS factor 2 + SS interaction + SS inter  %</span>
<span class="comment">%---------------------------------------------------------------------%</span>


<span class="comment">% --------------------------------------------------</span>
<span class="comment">% Factor 1                       1           2</span>
<span class="comment">% Factor 2                    1     2     1     2</span>
<span class="comment">% --------------------------------------------------</span>
<span class="comment">% observation 1               8     5     3     6</span>
<span class="comment">% observation 2               9     7     4     4</span>
<span class="comment">% observation 3               7     3     1     9</span>
<span class="comment">% --------------------------------------------------</span>

clear

<span class="comment">% data</span>
y = [8 9 7 5 7 3 3 4 1 6 4 9]';

<span class="comment">% design matrix</span>
n = 3;
Factor1 = [ones(1,n*2) ones(1,n*2)*-1]'; <span class="comment">% 6 first observations are level 1 then ^ next level 2</span>
Factor2 = [ones(1,n) ones(1,n)*-1 ones(1,n) ones(1,n)*-1]';
I       = (Factor1.*Factor2);
X       = [Factor1 Factor2 I];

<span class="comment">% solve the full model</span>
[betas, error, stats] = glmfit(X,y,<span class="string">'normal'</span>);
yhat                  = glmval(betas, X, <span class="string">'identity'</span>);
ss_total              = norm(y - mean(y)).^2;
ss_effect             = norm(yhat - mean(yhat)).^2;
Rsquare               = ss_effect/ss_total; <span class="comment">% adjustment of the all model</span>
F_model               = (Rsquare *(length(y)-rank(X)-1))/((1- Rsquare)*rank(X));
pval                  = 1 - fcdf(F_model, rank(X), (length(y)-rank(X)-1));

<span class="comment">% NOTE THAT THE FULL MODEL GIVES THE SAME R SQUARE AS ABOVE</span>

<span class="comment">% as the model is additive, solve each factor</span>
<span class="comment">% but relative to the error of the full model</span>

[betas, errorF1, stats] = glmfit(Factor1,y,<span class="string">'normal'</span>);
yhat_F1                 = glmval(betas, Factor1, <span class="string">'identity'</span>);
ss_effectF1             = norm(yhat_F1 - mean(yhat_F1)).^2;
F_F1                    = (ss_effectF1/rank(Factor1)) / (error/(length(y)-rank(X)-1))
pval_F1                 = 1 - fcdf(F_F1, rank(Factor1), (length(y)-rank(X)-1));

[betas, errorF2, stats] = glmfit(Factor2,y,<span class="string">'normal'</span>);
yhat_F2                 = glmval(betas, Factor2, <span class="string">'identity'</span>);
ss_effectF2             = norm(yhat_F2 - mean(yhat_F2)).^2;
F_F2                    = (ss_effectF2/rank(Factor2)) / (error/(length(y)-rank(X)-1))
pval_F2                 = 1 - fcdf(F_F2, rank(Factor2), (length(y)-rank(X)-1));

[betas, errorI, stats]  = glmfit(I,y,<span class="string">'normal'</span>);
yhat_I                  = glmval(betas, I, <span class="string">'identity'</span>);
ss_effectI              = norm(yhat_I - mean(yhat_I)).^2;
F_I                     = (ss_effectI/rank(I)) / (error/(length(y)-rank(X)-1))
pval_I                  = 1 - fcdf(F_I, rank(I), (length(y)-rank(X)-1));


<span class="comment">% figures</span>
figure;
subplot(1,3,1)
imagesc(X); colormap(<span class="string">'gray'</span>);
title(<span class="string">'Two ways ANOVA 2x2'</span>)
subplot(1,3,2);
plot(y); hold <span class="string">on</span>; plot(yhat,<span class="string">'r'</span>); axis <span class="string">tight</span>
mytitle1 = sprintf(<span class="string">'R square = %g'</span>, Rsquare);
mytitle2 = sprintf(<span class="string">'F(%g,%g)= %g p= %g'</span>, rank(X), (length(y)-rank(X)-1), F_model, pval);
title({<span class="string">'model and data'</span>;[mytitle2];[mytitle1]})
subplot(1,3,3); normplot(y-yhat);

figure;
subplot(1,3,1);
plot(y); hold <span class="string">on</span>; plot(yhat_F1,<span class="string">'r'</span>); axis <span class="string">tight</span>
mytitle1 = sprintf(<span class="string">'F(%g,%g)=%g'</span>, rank(Factor1), (length(y)-rank(X)-1), F_F1);
mytitle2 = sprintf(<span class="string">'p=%g'</span>, pval_F1);
title({<span class="string">'Factor1'</span>;[mytitle1];[mytitle2]})
subplot(1,3,2);
plot(y); hold <span class="string">on</span>; plot(yhat_F2,<span class="string">'r'</span>); axis <span class="string">tight</span>
mytitle1 = sprintf(<span class="string">'F(%g,%g)=%g'</span>, rank(Factor2), (length(y)-rank(X)-1), F_F2);
mytitle2 = sprintf(<span class="string">'p=%g'</span>, pval_F2);
title({<span class="string">'Factor1'</span>;[mytitle1];[mytitle2]})
subplot(1,3,3);
plot(y); hold <span class="string">on</span>; plot(yhat_I,<span class="string">'r'</span>); axis <span class="string">tight</span>
mytitle1 = sprintf(<span class="string">'F(%g,%g)=%g'</span>, rank(I), (length(y)-rank(X)-1), F_I);
mytitle2 = sprintf(<span class="string">'p=%g'</span>, pval_I);
title({<span class="string">'Interaction'</span>;[mytitle1];[mytitle2]})
</pre><pre class="codeoutput">
F_F1 =

    3.5122


F_F2 =

    0.0976


F_I =

    9.7561

</pre><img vspace="5" hspace="5" src="cp_glm3_03.png"> <img vspace="5" hspace="5" src="cp_glm3_04.png"> <h2>Repeated measures ANOVA 1 factor<a name="4"></a></h2><pre class="codeinput"><span class="comment">%---------------------------------------------------------%</span>
<span class="comment">%  SS total = SS repeated factor + SS subject + SS intra  %</span>
<span class="comment">%---------------------------------------------------------%</span>


<span class="comment">% --------------------------------------------------</span>
<span class="comment">%                             1     2     1     2</span>
<span class="comment">% --------------------------------------------------</span>
<span class="comment">% subject 1                   8     5     3     6</span>
<span class="comment">% subject 2                   9     7     4     4</span>
<span class="comment">% subject 3                   7     3     1     9</span>
<span class="comment">% --------------------------------------------------</span>

clear

<span class="comment">% data</span>
y = [8 9 7 5 7 3 3 4 1 6 4 9]';

<span class="comment">% design matrix</span>
n = 3;
F = [ones(1,n) zeros(1,2*n) (ones(1,n)*-1); <span class="keyword">...</span>
       zeros(1,n) ones(1,n) zeros(1,n) (ones(1,n)*-1); <span class="keyword">...</span>
       zeros(1,2*n) ones(1,n) (ones(1,n)*-1)]'; <span class="comment">% same as one way ANOVA</span>
S = [(8+5+3+6) (9+7+4+4) (7+3+1+9)]'; <span class="comment">% take the sum of each subject</span>
X = [F repmat(S,4,1)]

<span class="comment">% solve the full model</span>
[betas, error, stats] = glmfit(X,y,<span class="string">'normal'</span>);
yhat                  = glmval(betas, X, <span class="string">'identity'</span>);
ss_total              = norm(y - mean(y)).^2;
ss_effect             = norm(yhat - mean(yhat)).^2;
Rsquare               = ss_effect/ss_total; <span class="comment">% adjustment of the all model</span>
F_model               = (Rsquare *(length(y)-rank(X)-1))/((1- Rsquare)*rank(X));
pval                  = 1 - fcdf(F_model, rank(X), (length(y)-rank(X)-1));

<span class="comment">% since the model is additive we can solve each part - but keep in mind we</span>
<span class="comment">% have the subject effect to remove ...</span>
[betas, error_S, stats] = glmfit(repmat(S,4,1),y,<span class="string">'normal'</span>);
yhat_S                  = glmval(betas, repmat(S,4,1), <span class="string">'identity'</span>);
ss_effect_S             = norm(yhat_S - mean(yhat_S)).^2;

[betas, error, stats] = glmfit(F,y,<span class="string">'normal'</span>);
yhat_F                = glmval(betas, F, <span class="string">'identity'</span>);
ss_total              = norm(y - mean(y)).^2;
ss_effect_F           = norm(yhat_F - mean(yhat_F)).^2;
F_F                   = (ss_effect_F/rank(F)) / ((error-ss_effect_S)/(length(X)-rank(F)-(n-1)-1));
pval_F                = 1 - fcdf(F_F, rank(F), (length(X)-rank(F)-(n-1)-1));

<span class="comment">% figures</span>
figure
subplot(1,2,1); imagesc(zscore(X)); colormap(<span class="string">'gray'</span>);
title(<span class="string">'Repeated measures ANOVA 4 conditions'</span>)
subplot(1,2,2);
plot(y); hold <span class="string">on</span>; plot(yhat,<span class="string">'r'</span>); axis <span class="string">tight</span>
mytitle1 = sprintf(<span class="string">'R square = %g'</span>, Rsquare);
mytitle2 = sprintf(<span class="string">'F(%g,%g)= %g p= %g'</span>, rank(X), (length(y)-rank(X)-1), F_model, pval);
title({<span class="string">'model and data'</span>;[mytitle2];[mytitle1]})

figure; subplot(1,3,1);
plot(y); hold <span class="string">on</span>; plot(yhat_S,<span class="string">'r'</span>); axis <span class="string">tight</span>
title(<span class="string">'Subject effect'</span>)
subplot(1,3,2);
plot(y); hold <span class="string">on</span>; plot(yhat,<span class="string">'r'</span>); axis <span class="string">tight</span>
mytitle1 = sprintf(<span class="string">'F(%g,%g)=%g'</span>, rank(F), (length(X)-rank(F)-(n-1)-1), F_F);
mytitle2 = sprintf(<span class="string">'p=%g'</span>, pval_F);
title({<span class="string">'Repeated Factor'</span>;[mytitle1];[mytitle2]})
subplot(1,3,3); normplot(y-yhat);
</pre><pre class="codeoutput">
X =

     1     0     0    22
     1     0     0    24
     1     0     0    20
     0     1     0    22
     0     1     0    24
     0     1     0    20
     0     0     1    22
     0     0     1    24
     0     0     1    20
    -1    -1    -1    22
    -1    -1    -1    24
    -1    -1    -1    20

</pre><img vspace="5" hspace="5" src="cp_glm3_05.png"> <img vspace="5" hspace="5" src="cp_glm3_06.png"> <h2>Embeded ANOVA design (1 factor independant, 1 factor repeated)<a name="6"></a></h2>
<pre class="codeinput"><span class="comment">%---------------------------------------------------------------------%</span>
<span class="comment">%  SS total = SS factor 1 + SS factor 2 + SS interaction ...          %</span>
<span class="comment">%              + SS inter + SS intra                                  %</span>
<span class="comment">%---------------------------------------------------------------------%</span>


<span class="comment">% --------------------------------------------------</span>
<span class="comment">% Factor 1                       1           2</span>
<span class="comment">% Factor 2                    1     2     1     2</span>
<span class="comment">% --------------------------------------------------</span>
<span class="comment">% subject 1                   8     5</span>
<span class="comment">% subject 2                   9     7</span>
<span class="comment">% subject 3                   7     3</span>
<span class="comment">% subject 4                               3     6</span>
<span class="comment">% subject 5                               4     4</span>
<span class="comment">% subject 6                               1     9</span>
<span class="comment">% --------------------------------------------------</span>

clear

<span class="comment">% data</span>
y = [8 9 7 5 7 3 3 4 1 6 4 9]';

<span class="comment">% design matrix</span>
n = 3;
Factor1 = [ones(1,n*2) ones(1,n*2)*-1]'; <span class="comment">% gp</span>
Factor2 = [ones(1,n) ones(1,n)*-1 ones(1,n) ones(1,n)*-1]'; <span class="comment">% repeated measures</span>
I = Factor1.*Factor2;
S = [(8+5) (9+7) (7+3) (8+5) (9+7) (7+3) (3+6) (4+4) (1+9) (3+6) (4+4) (1+9)]';
X = [Factor1 Factor2 I S];

<span class="comment">% solve</span>
<span class="comment">% ---- repeated measures and interaction -----------</span>
[betas, error, stats]    = glmfit(X,y,<span class="string">'normal'</span>);
yhat                     = glmval(betas, X, <span class="string">'identity'</span>);

<span class="comment">% two different R^2 should be computed but here I just do the full model</span>
Rsquare                  = (norm(yhat - mean(yhat)).^2)/(norm(y-mean(y)).^2);

[betas, error_F2, stats] = glmfit(Factor2,y,<span class="string">'normal'</span>);
yhat_F2                  = glmval(betas, Factor2, <span class="string">'identity'</span>);
[betas, error_I, stats]  = glmfit(I,y,<span class="string">'normal'</span>);
yhat_I                   = glmval(betas, I, <span class="string">'identity'</span>);
ss_effect_F2             = norm(yhat_F2 - mean(yhat_F2)).^2;
ss_effect_I              = norm(yhat_I - mean(yhat_I)).^2;

F_F2                     = (ss_effect_F2/rank(Factor2)) / (error/rank(X));
pval_F2                  = 1 - fcdf(F_F2, rank(Factor2), rank(X));
F_I                      = (ss_effect_I/rank(I)) / (error/rank(X));
pval_I                   = 1 - fcdf(F_I, rank(I), rank(X));

<span class="comment">% -------- independant factor ------------------------</span>
[betas, error_F1, stats] = glmfit(Factor1,y,<span class="string">'normal'</span>);
yhat_F1                  = glmval(betas, Factor1, <span class="string">'identity'</span>);
ss_effect_F1             = norm(yhat_F1 - mean(yhat_F1)).^2;

<span class="comment">% the long way to get the error inter gp is</span>
<span class="comment">% [betas, error_S, stats] = glmfit(S,y,'normal');</span>
<span class="comment">% yhat_S = glmval(betas, S, 'identity');</span>
<span class="comment">% ss_effect_S = norm(yhat_S-mean(yhat_S)).^2</span>
<span class="comment">% error_inter = ss_effect_S - ss_effect_F1;</span>

<span class="comment">% the quick way is</span>
error_inter = (norm(y-mean(y)).^2) - ss_effect_F1 - ss_effect_F2 - ss_effect_I - error;
F_F1        = (ss_effect_F1/rank(Factor1)) / (error_inter/rank(X));
pval_F1     = 1 - fcdf(F_F1, rank(Factor1), rank(X));

<span class="comment">% figures</span>
figure;
subplot(1,3,1)
imagesc(zscore(X)); colormap(<span class="string">'gray'</span>)
title(<span class="string">'Design matrix'</span>)
subplot(1,3,2)
plot(y); hold <span class="string">on</span>; plot(yhat,<span class="string">'r'</span>); axis <span class="string">tight</span>
title([<span class="string">'Rsquare ='</span>,num2str(Rsquare)])
subplot(1,3,3); normplot(y-yhat)

figure;
subplot(1,3,1)'
plot(y); hold <span class="string">on</span>; plot(yhat_F1,<span class="string">'r'</span>); axis <span class="string">tight</span>
mytitle = sprintf(<span class="string">'F(%g,%g)=%g p= %g'</span>,rank(Factor1),rank(X),F_F1,pval_F1);
title({<span class="string">'Gp effect'</span>;[mytitle]})
subplot(1,3,2);
plot(y); hold <span class="string">on</span>; plot(yhat_F2,<span class="string">'r'</span>); axis <span class="string">tight</span>
mytitle = sprintf(<span class="string">'F(%g,%g)=%g p= %g'</span>,rank(Factor2),rank(X),F_F2,pval_F2);
title({[mytitle];<span class="string">'Repeated measure effect'</span>})
subplot(1,3,3);
plot(y); hold <span class="string">on</span>; plot(yhat_I,<span class="string">'r'</span>); axis <span class="string">tight</span>
mytitle = sprintf(<span class="string">'F(%g,%g)=%g p= %g'</span>,rank(I),rank(X),F_I,pval_I);
title({<span class="string">'Interaction'</span>;[mytitle]})
</pre><p class="footer"><br>
            Published with MATLAB&reg; 7.2<br></p>
      </div>
      <!--
##### SOURCE BEGIN #####
% In this last page I review the different ANOVA
% models and how to implement them in matlab using
% the glm 

%% One way ANOVA

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH%
%  SS total = SS intra + SS inter  %
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH%
% this repeat what was explained in glm2


% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
%                           gp 1   gp2   gp3   gp4
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% observation 1               8     5     3     6
% observation 2               9     7     4     4
% observation 3               7     3     1     9
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

clear

%data
y = [8 9 7 5 7 3 3 4 1 6 4 9]'; 

% design matrix
n = 3;
X = [ones(1,n) zeros(1,2*n) (ones(1,n)*-1); ...
       zeros(1,n) ones(1,n) zeros(1,n) (ones(1,n)*-1); ...
       zeros(1,2*n) ones(1,n) (ones(1,n)*-1)]';

% solve
[betas, error, stats] = glmfit(X,y,'normal');
yhat                  = glmval(betas, X, 'identity');
ss_total              = norm(y - mean(y)).^2; 
ss_effect             = norm(yhat - mean(yhat)).^2; 
Rsquare               = ss_effect/ss_total; % adjustment of the all model
F                     = (Rsquare *(length(y)-rank(X)-1))/((1- Rsquare)*rank(X));
pval                  = 1 - fcdf(F, rank(X), (length(y)-rank(X)-1));

% figures
figure
subplot(1,2,1); imagesc(X); colormap('gray');
title('One way ANOVA 4 gps')
subplot(1,2,2); 
plot(y); hold on; plot(yhat,'r'); axis tight
mytitle = sprintf('R square = %g', Rsquare);
title({'model and data';[mytitle]})
figure; 
subplot(1,2,1); 
boxplot([8 9 7 ;5 7 3 ;3 4 1 ;6 4 9]');
mytitle = sprintf('F(%g,%g)=%g, p=%g',(length(y)-rank(X)-1), rank(X), F, pval);
title([mytitle])
subplot(1,2,2); normplot(y-yhat);


%% Two way ANOVA

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-%
%  SS total = SS factor 1 + SS factor 2 + SS interaction + SS inter  %
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-%


% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Factor 1                       1           2
% Factor 2                    1     2     1     2
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% observation 1               8     5     3     6
% observation 2               9     7     4     4
% observation 3               7     3     1     9
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

clear

% data
y = [8 9 7 5 7 3 3 4 1 6 4 9]'; 

% design matrix
n = 3;
Factor1 = [ones(1,n*2) ones(1,n*2)*-1]'; % 6 first observations are level 1 then ^ next level 2
Factor2 = [ones(1,n) ones(1,n)*-1 ones(1,n) ones(1,n)*-1]';
I       = (Factor1.*Factor2);
X       = [Factor1 Factor2 I];

% solve the full model
[betas, error, stats] = glmfit(X,y,'normal');
yhat                  = glmval(betas, X, 'identity');
ss_total              = norm(y - mean(y)).^2; 
ss_effect             = norm(yhat - mean(yhat)).^2; 
Rsquare               = ss_effect/ss_total; % adjustment of the all model
F_model               = (Rsquare *(length(y)-rank(X)-1))/((1- Rsquare)*rank(X));
pval                  = 1 - fcdf(F_model, rank(X), (length(y)-rank(X)-1));

% NOTE THAT THE FULL MODEL GIVES THE SAME R SQUARE AS ABOVE

% as the model is additive, solve each factor 
% but relative to the error of the full model

[betas, errorF1, stats] = glmfit(Factor1,y,'normal');
yhat_F1                 = glmval(betas, Factor1, 'identity');
ss_effectF1             = norm(yhat_F1 - mean(yhat_F1)).^2; 
F_F1                    = (ss_effectF1/rank(Factor1)) / (error/(length(y)-rank(X)-1))
pval_F1                 = 1 - fcdf(F_F1, rank(Factor1), (length(y)-rank(X)-1));

[betas, errorF2, stats] = glmfit(Factor2,y,'normal');
yhat_F2                 = glmval(betas, Factor2, 'identity');
ss_effectF2             = norm(yhat_F2 - mean(yhat_F2)).^2; 
F_F2                    = (ss_effectF2/rank(Factor2)) / (error/(length(y)-rank(X)-1))
pval_F2                 = 1 - fcdf(F_F2, rank(Factor2), (length(y)-rank(X)-1));

[betas, errorI, stats]  = glmfit(I,y,'normal');
yhat_I                  = glmval(betas, I, 'identity');
ss_effectI              = norm(yhat_I - mean(yhat_I)).^2; 
F_I                     = (ss_effectI/rank(I)) / (error/(length(y)-rank(X)-1))
pval_I                  = 1 - fcdf(F_I, rank(I), (length(y)-rank(X)-1));


% figures
figure; 
subplot(1,3,1)
imagesc(X); colormap('gray');
title('Two ways ANOVA 2x2')
subplot(1,3,2); 
plot(y); hold on; plot(yhat,'r'); axis tight
mytitle1 = sprintf('R square = %g', Rsquare);
mytitle2 = sprintf('F(%g,%g)= %g p= %g', rank(X), (length(y)-rank(X)-1), F_model, pval);
title({'model and data';[mytitle2];[mytitle1]})
subplot(1,3,3); normplot(y-yhat);

figure;
subplot(1,3,1); 
plot(y); hold on; plot(yhat_F1,'r'); axis tight
mytitle1 = sprintf('F(%g,%g)=%g', rank(Factor1), (length(y)-rank(X)-1), F_F1);
mytitle2 = sprintf('p=%g', pval_F1);
title({'Factor1';[mytitle1];[mytitle2]})
subplot(1,3,2); 
plot(y); hold on; plot(yhat_F2,'r'); axis tight
mytitle1 = sprintf('F(%g,%g)=%g', rank(Factor2), (length(y)-rank(X)-1), F_F2);
mytitle2 = sprintf('p=%g', pval_F2);
title({'Factor1';[mytitle1];[mytitle2]})
subplot(1,3,3); 
plot(y); hold on; plot(yhat_I,'r'); axis tight
mytitle1 = sprintf('F(%g,%g)=%g', rank(I), (length(y)-rank(X)-1), F_I);
mytitle2 = sprintf('p=%g', pval_I);
title({'Interaction';[mytitle1];[mytitle2]})


%% Repeated measures ANOVA 1 factor

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-%
%  SS total = SS repeated factor + SS subject + SS intra  %
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-%


% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
%                             1     2     1     2
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% subject 1                   8     5     3     6
% subject 2                   9     7     4     4
% subject 3                   7     3     1     9
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

clear

% data
y = [8 9 7 5 7 3 3 4 1 6 4 9]'; 

% design matrix
n = 3;
F = [ones(1,n) zeros(1,2*n) (ones(1,n)*-1); ...
       zeros(1,n) ones(1,n) zeros(1,n) (ones(1,n)*-1); ...
       zeros(1,2*n) ones(1,n) (ones(1,n)*-1)]'; % same as one way ANOVA
S = [(8+5+3+6) (9+7+4+4) (7+3+1+9)]'; % take the sum of each subject
X = [F repmat(S,4,1)]

% solve the full model
[betas, error, stats] = glmfit(X,y,'normal');
yhat                  = glmval(betas, X, 'identity');
ss_total              = norm(y - mean(y)).^2; 
ss_effect             = norm(yhat - mean(yhat)).^2; 
Rsquare               = ss_effect/ss_total; % adjustment of the all model
F_model               = (Rsquare *(length(y)-rank(X)-1))/((1- Rsquare)*rank(X));
pval                  = 1 - fcdf(F_model, rank(X), (length(y)-rank(X)-1));

% since the model is additive we can solve each part - but keep in mind we
% have the subject effect to remove ...
[betas, error_S, stats] = glmfit(repmat(S,4,1),y,'normal');
yhat_S                  = glmval(betas, repmat(S,4,1), 'identity');
ss_effect_S             = norm(yhat_S - mean(yhat_S)).^2; 

[betas, error, stats] = glmfit(F,y,'normal');
yhat_F                = glmval(betas, F, 'identity');
ss_total              = norm(y - mean(y)).^2; 
ss_effect_F           = norm(yhat_F - mean(yhat_F)).^2; 
F_F                   = (ss_effect_F/rank(F)) / ((error-ss_effect_S)/(length(X)-rank(F)-(n-1)-1));
pval_F                = 1 - fcdf(F_F, rank(F), (length(X)-rank(F)-(n-1)-1));

% figures
figure
subplot(1,2,1); imagesc(zscore(X)); colormap('gray');
title('Repeated measures ANOVA 4 conditions')
subplot(1,2,2); 
plot(y); hold on; plot(yhat,'r'); axis tight
mytitle1 = sprintf('R square = %g', Rsquare);
mytitle2 = sprintf('F(%g,%g)= %g p= %g', rank(X), (length(y)-rank(X)-1), F_model, pval);
title({'model and data';[mytitle2];[mytitle1]})

figure; subplot(1,3,1); 
plot(y); hold on; plot(yhat_S,'r'); axis tight
title('Subject effect')
subplot(1,3,2); 
plot(y); hold on; plot(yhat,'r'); axis tight
mytitle1 = sprintf('F(%g,%g)=%g', rank(F), (length(X)-rank(F)-(n-1)-1), F_F);
mytitle2 = sprintf('p=%g', pval_F);
title({'Repeated Factor';[mytitle1];[mytitle2]})
subplot(1,3,3); normplot(y-yhat);

%% Repeated measures ANOVA 2 factors

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH%
%  SS total = SS factor 1 + SS factor 2 + SS interaction + SS subject ... %
%              + SS factor 1 x subject + SS factor 2 x subject + SS intra  %   
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH%

% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Factor 1                       1           2
% Factor 2                    1     2     1     2
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% subject 1                   8     5     3     6
% subject 2                   9     7     4     4
% subject 3                   7     3     1     9
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

clear

% data
y = [8 9 7 5 7 3 3 4 1 6 4 9]'; 

% design matrix
n = 3;
Factor1 = [ones(1,n*2) ones(1,n*2)*-1]'; 
Factor2 = [ones(1,n) ones(1,n)*-1 ones(1,n) ones(1,n)*-1]';
IF12 = (Factor1.*Factor2);
S = [(8+5+3+6) (9+7+4+4) (7+3+1+9)]';
IF1S = Factor1 .* repmat(S,4,1);
IF2S = Factor2 .* repmat(S,4,1);
X = [Factor1 Factor2 IF12 repmat(S,4,1) IF1S IF2S];
figure; 
imagesc(zscore(X)); colormap('gray')
title({'2 factors'; 'repeated measures'})

% solve for each part of the model - but each factor uses it's interaction
% with the subjects as error

% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH factor 1 REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
[betas, error_F1, stats] = glmfit(Factor1,y,'normal');
yhat_F1                  = glmval(betas, Factor1, 'identity');
ss_effect_F1             = norm(yhat_F1 - mean(yhat_F1)).^2; 
figure; subplot(1,3,1);
plot(y); hold on; plot(yhat_F1,'r'); axis tight

% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH factor 2 REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
[betas, error_F2, stats] = glmfit(Factor2,y,'normal');
yhat_F2                  = glmval(betas, Factor2, 'identity');
ss_effect_F2             = norm(yhat_F2 - mean(yhat_F2)).^2; 
subplot(1,3,2);
plot(y); hold on; plot(yhat_F2,'r'); axis tight

% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH interaction f1 x f2 REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
[betas, error_IF12, stats] = glmfit(IF12,y,'normal');
yhat_IF12                  = glmval(betas, IF12, 'identity');
ss_effect_IF12             = norm(yhat_IF12 - mean(yhat_IF12)).^2; 
subplot(1,3,3);
plot(y); hold on; plot(yhat_IF12,'r'); axis tight

% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH the remaining goes into the error REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH subject REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
[betas, error_S, stats] = glmfit(repmat(S,4,1),y,'normal');
yhat_S                  = glmval(betas, repmat(S,4,1), 'identity');
ss_effect_S             = norm(yhat_S - mean(yhat_S)).^2; 



error = error - ss_effect_S;
error = y - (yhat_F1 + yhat_F2 + yhat_IF12 - 2*mean(y));
ss_total = norm(y-mean(y)).^2;
ss_total - ss_effect_F1 - ss_effect_F2 - ss_effect_IF12



% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH- repartition of the error REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
[betas, error_IF1S, stats] = glmfit(IF1S,y,'normal');
yhat_IF1S                    = glmval(betas, IF1S, 'identity');
ss_effect_IF1S             = norm(yhat_IF1S - mean(yhat_IF1S)).^2; 
subplot(1,3,2);
plot(y); hold on; plot(yhat,'r'); axis tight
title('Subject x Factor1 effect')

[betas, error_IF2S, stats] = glmfit(IF2S,y,'normal');
yhat                    = glmval(betas, IF2S, 'identity');
ss_effect_IF2S             = norm(yhat - mean(yhat)).^2; 
subplot(1,3,3);
plot(y); hold on; plot(yhat,'r'); axis tight
title('Subject x Factor 2 effect')




title('Subject x Factor 2 effect')





%% Embeded ANOVA design (1 factor independant, 1 factor repeated)

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-%
%  SS total = SS factor 1 + SS factor 2 + SS interaction ...          %
%              + SS inter + SS intra                                  %
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-%


% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Factor 1                       1           2
% Factor 2                    1     2     1     2
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% subject 1                   8     5           
% subject 2                   9     7    
% subject 3                   7     3   
% subject 4                               3     6
% subject 5                               4     4
% subject 6                               1     9
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

clear

% data
y = [8 9 7 5 7 3 3 4 1 6 4 9]'; 

% design matrix
n = 3;
Factor1 = [ones(1,n*2) ones(1,n*2)*-1]'; % gp
Factor2 = [ones(1,n) ones(1,n)*-1 ones(1,n) ones(1,n)*-1]'; % repeated measures
I = Factor1.*Factor2;
S = [(8+5) (9+7) (7+3) (8+5) (9+7) (7+3) (3+6) (4+4) (1+9) (3+6) (4+4) (1+9)]';
X = [Factor1 Factor2 I S];

% solve
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH repeated measures and interaction REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
[betas, error, stats]    = glmfit(X,y,'normal');
yhat                     = glmval(betas, X, 'identity');

% two different R^2 should be computed but here I just do the full model
Rsquare                  = (norm(yhat - mean(yhat)).^2)/(norm(y-mean(y)).^2);

[betas, error_F2, stats] = glmfit(Factor2,y,'normal');
yhat_F2                  = glmval(betas, Factor2, 'identity');
[betas, error_I, stats]  = glmfit(I,y,'normal');
yhat_I                   = glmval(betas, I, 'identity');
ss_effect_F2             = norm(yhat_F2 - mean(yhat_F2)).^2; 
ss_effect_I              = norm(yhat_I - mean(yhat_I)).^2; 

F_F2                     = (ss_effect_F2/rank(Factor2)) / (error/rank(X));
pval_F2                  = 1 - fcdf(F_F2, rank(Factor2), rank(X));
F_I                      = (ss_effect_I/rank(I)) / (error/rank(X));
pval_I                   = 1 - fcdf(F_I, rank(I), rank(X));

% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH independant factor REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
[betas, error_F1, stats] = glmfit(Factor1,y,'normal');
yhat_F1                  = glmval(betas, Factor1, 'identity');
ss_effect_F1             = norm(yhat_F1 - mean(yhat_F1)).^2; 

% the long way to get the error inter gp is
% [betas, error_S, stats] = glmfit(S,y,'normal');
% yhat_S = glmval(betas, S, 'identity');
% ss_effect_S = norm(yhat_S-mean(yhat_S)).^2
% error_inter = ss_effect_S - ss_effect_F1; 

% the quick way is
error_inter = (norm(y-mean(y)).^2) - ss_effect_F1 - ss_effect_F2 - ss_effect_I - error;
F_F1        = (ss_effect_F1/rank(Factor1)) / (error_inter/rank(X));
pval_F1     = 1 - fcdf(F_F1, rank(Factor1), rank(X));

% figures
figure;
subplot(1,3,1)
imagesc(zscore(X)); colormap('gray')
title('Design matrix')
subplot(1,3,2)
plot(y); hold on; plot(yhat,'r'); axis tight
title(['Rsquare =',num2str(Rsquare)])
subplot(1,3,3); normplot(y-yhat)

figure;
subplot(1,3,1)'
plot(y); hold on; plot(yhat_F1,'r'); axis tight
mytitle = sprintf('F(%g,%g)=%g p= %g',rank(Factor1),rank(X),F_F1,pval_F1);
title({'Gp effect';[mytitle]})
subplot(1,3,2);
plot(y); hold on; plot(yhat_F2,'r'); axis tight
mytitle = sprintf('F(%g,%g)=%g p= %g',rank(Factor2),rank(X),F_F2,pval_F2);
title({[mytitle];'Repeated measure effect'})
subplot(1,3,3);
plot(y); hold on; plot(yhat_I,'r'); axis tight
mytitle = sprintf('F(%g,%g)=%g p= %g',rank(I),rank(X),F_I,pval_I);
title({'Interaction';[mytitle]})


##### SOURCE END #####
-->
   </body>
</html>